---
title: "pneumo israel"
author: "Dan Weinberger"
date: "2/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(reshape2)
library(ggplot2)
library(lubridate)
library(dplyr)
library(INLA)
library(tidyr)
library(htmlTable)
library(pbapply)

source('./R/format_carr.R')
source('./R/format_caap.R')
source('./R/format_virus.R')
source('./R/format_ipd_func.R')
source('./R/inla_model3.R')
source('./R/Plot_Obs_exp_counterfact.R')
source('./R/attrib_pct_func.R')
source('./R/attrib_pct_fmt_func.R')
source('./R/attrib_pct_fmt_func_age.R')

source('./R/gen_pred_interval_inla_ridge_ar1.R')

```

-CAAP and non-CAAP LRI 2016-2021 (southern Israel, children <5y)

-IPD 2016-2021 (Nationwide children <5y)

-All viruses (all nasal washes obtained, southern Israel, children <5y)

-CAAP virus coinfections 2016-2021 (Children <5y with CAAP and virus positive, southern Israel)

-Non-CAAP LRI virus coinfections 2016-2021 (Children <5y with non-CAAP LRI and virus positive, southern Israel)

-Carriage plus density 2016-2021 (Children <3y, no respiratory diagnosis, southern Israel)
 

```{r}
carr.formatted <- format_carr()

carr2.c <- carr.formatted$carr2.c

carr2.c <- carr2.c %>%
          group_by(ethnicity, agec) %>%
          mutate(N_swab=POS+NEG,
                  lag1_POS=lag(POS),
                 lag2_pOS=lag(POS,2),
                 lag1_N_swab=lag(N_swab),
                 lag2_N_swab=lag(N_swab,2),
                 prev_movave= (POS+lag1_POS+lag2_pOS)/(N_swab+lag1_N_swab+lag2_N_swab))

p1 <- ggplot(carr2.c, aes(x=date, y=prev_movave, group=ethnicity, col=ethnicity))+
  geom_line() +
  theme_classic()+
  facet_wrap(~agec) +
  ylim(0, 1)

p1
```

Prevalence over time, subsetted by density. The change in prevalence seen in 2020 is due to drop in low-density carriage 
```{r}
carr.formatted$plot.density
```

Viruses

```{r, fig.width=6, fig.height=4}
virus_formatted <- format_virus()

vir2.c <- virus_formatted$vir2.c

virus_formatted$virus.plot
```

## CAAP

```{r, fig.width=6, fig.height=2}
c3 <- format_caap()

p3 <- ggplot(c3, aes(x=date, y=CAAP, group=ethnicity, col=ethnicity)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~agec, scales='free') +
  ggtitle('CAAP by age group and ethnicity')
p3


p4 <- ggplot(c3, aes(x=date, y=nonCAAP, group=ethnicity, col=ethnicity)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~agec, scales='free') +
  ggtitle('non-CAAP by age group and ethnicity')
p4

```

IPD
This script just brings in data for kids <1 year
```{r}
ipd1 <- format_ipd_func()

ipd1$p.ipd_other

ipd1$p.ipd_pneu
```


Combine the virus, carriage and X-rays datasets
```{r}
all1 <- merge(c3, carr2.c, by=c('ethnicity', 'agec', 'date'), all=T)

all1 <- all1[!is.na(all1$CAAP) & all1$date>='2016-01-01',]

all1$prev[is.na(all1$prev)] <-0

all1 <- merge(all1, ipd1$ds[,c('agec','ethnicity','date','bacteremic.pneumonia','other.IPD')], by=c('ethnicity', 'agec', 'date'), all.x=T)


all1 <- merge(all1, vir2.c, by=c('ethnicity', 'date'), all=T)


all1$ethnicity <- as.factor(all1$ethnicity)

all1$agec <- as.factor(all1$agec)

all1$caap.pre <- all1$CAAP

all1$caap.pre[all1$date>=as.Date('2020-03-01')] <- NA

all1$non.caap.pre <- all1$nonCAAP
all1$non.caap.pre[all1$date>=as.Date('2020-03-01')] <- NA

all1$t <- interval(min(all1$date), all1$date) %/% months(1) 
all1$sin12 <- sin(2*pi*all1$t/12)
all1$cos12 <- cos(2*pi*all1$t/12)

all1$sin6 <- sin(2*pi*all1$t/6)
all1$cos6 <- cos(2*pi*all1$t/6)

all1$sin3 <- sin(2*pi*all1$t/3)
all1$cos3 <- cos(2*pi*all1$t/3)

all1$year <- year(all1$date)
all1$month <- month(all1$date)

all1$epiyr <- all1$year
all1$epiyr[all1$month<=6] <- all1$year[all1$month<=6]  - 1
all1$epiyr[all1$epiyr >2019] <- 2019
all1$epiyr <- as.factor(all1$epiyr)

all1$month <- as.factor(all1$month)

all1 <- all1[!is.na(all1$agec),]

```



## INLA MODELS

## CAAP, fit to pre-COVID data only

Fit  all mdoels to pre data only or to any 

```{r, eval=F}
res1.caap.pre <- inla_model3(all1,  outcome.var='caap.pre', plot.var='CAAP')

res1.caap.all <- inla_model3(all1,  outcome.var='CAAP', plot.var='CAAP')

res1.noncaap.pre <- inla_model3(all1,  outcome.var='non.caap.pre', plot.var='nonCAAP')

res1.noncaap.all <- inla_model3(all1,  outcome.var='nonCAAP', plot.var='nonCAAP')

res1.ipd.pneu.all <- inla_model3(all1,  outcome.var='bacteremic.pneumonia', plot.var='bacteremic.pneumonia')
res1.ipd.other.all <- inla_model3(all1,  outcome.var='other.IPD', plot.var='other.IPD')

mod.results <- list( 'res1.caap.pre'=res1.caap.pre,'res1.caap.all'=res1.caap.all,'res1.noncaap.pre'=res1.noncaap.pre,'res1.noncaap.all'=res1.noncaap.all,'res1.ipd.pneu.all'=res1.ipd.pneu.all,'res1.ipd.other.all'=res1.ipd.other.all)
saveRDS(mod.results,'./Results/model_fits.rds')
```

```{r}
mod.results <- readRDS('./Results/model_fits.rds')

res1.caap.pre <- mod.results$res1.caap.pre
res1.caap.all <- mod.results$res1.caap.all
res1.noncaap.pre <- mod.results$res1.noncaap.pre
res1.noncaap.all <- mod.results$res1.noncaap.all
res1.ipd.pneu.all <- mod.results$res1.ipd.pneu.all
res1.ipd.other.all <- mod.results$res1.ipd.other.all
```


```{r}

res1.caap.pre$obs_exp_plot

```

```{r, fig.width=4, fig.height=4}
res1.caap.pre$predict_plot
```



## CAAP, fit to ALL data

```{r}
res1.caap.all$obs_exp_plot
```

```{r, fig.width=4, fig.height=4}
res1.caap.all$predict_plot
```



## non-CAAP, fit to pre data

```{r}

res1.noncaap.pre$obs_exp_plot


res1.noncaap.all$obs_exp_plot

```
Observed vs expected for IPD, fit to entire dataset
```{r}

res1.ipd.pneu.all$obs_exp_plot
res1.ipd.other.all$obs_exp_plot

```

## Compare attributable percents for different outcomes, etc
```{r}
ap1 <- attrib_pct_fmt_func(res1.caap.all,'CAAP_all')

ap2 <- attrib_pct_fmt_func(res1.caap.pre,'CAAP_pre')


ap3 <- attrib_pct_fmt_func(res1.noncaap.all,'NonCAAP_all')

ap4 <- attrib_pct_fmt_func(res1.noncaap.pre,'NonCAAP_pre')

ap5 <- attrib_pct_fmt_func(res1.ipd.pneu.all,'IPD_pneumonia_all')

ap6 <- attrib_pct_fmt_func(res1.ipd.other.all,'IPD_other_all')


#htmlTable(cbind(ap2, ap4[,2], ap1[,2], ap3[,2]))


htmlTable(cbind(ap1, ap3[,2], ap5[,2], ap6[,2]))


```
Age
```{r}
age_ap1 <- attrib_pct_fmt_func_age(res1.caap.all,'CAAP_all')

age_ap2 <- attrib_pct_fmt_func_age(res1.caap.pre,'CAAP_pre')


age_ap3 <- attrib_pct_fmt_func_age(res1.noncaap.all,'NonCAAP_all')

age_ap4 <- attrib_pct_fmt_func_age(res1.noncaap.pre,'NonCAAP_pre')

age_ap5 <- attrib_pct_fmt_func_age(res1.ipd.pneu.all,'IPD_pneumonia_all')

age_ap6 <- attrib_pct_fmt_func_age(res1.ipd.other.all,'IPD_other_all')


#htmlTable(cbind(ap2, ap4[,2], ap1[,2], ap3[,2]))

combined.df <- cbind(age_ap1, age_ap3[,3], age_ap5[,3], age_ap6[,3])

htmlTable(combined.df, rgroup=c('Any Virus','RSV','hMPV','Flu','Adeno', 'paraflu'), n.rgroup=rep(3,6) )

combined.df$virus <- factor(combined.df$virus, levels=c('any','rsv','hmpv','flu','adeno','paraflu'))


combined.df2 <- combined.df[order(combined.df$agec, combined.df$virus),]

htmlTable(combined.df2, rgroup=c('<12m','12-23m','2-4y'), n.rgroup=rep(6,3) )

```


Rhino--only available in recent times
```{r}

all1$out.scale <- scale(all1$CAAP/all1$pop*1000)
modr1 <- lm(CAAP ~ agec*ethnicity *(RSV + influenza.a + influenza.b + hMPV + parainfluenza + rhinovirus ) , data=all1)

modr2 <- lm(CAAP ~ agec + ethnicity *(RSV + influenza.a + influenza.b + hMPV + parainfluenza + rhinovirus ) , data=all1)

modr3 <- lm(CAAP ~ ethnicity +agec*(RSV + influenza.a + influenza.b + hMPV + parainfluenza + rhinovirus ) , data=all1)

modr4 <- lm(CAAP ~ ethnicity*(RSV + influenza.a + influenza.b + hMPV + parainfluenza + rhinovirus ) +
              agec*(RSV + influenza.a + influenza.b + hMPV + parainfluenza + rhinovirus ) , data=all1)


AIC(modr1, modr2, modr3,modr4)
summary(modr)
```


