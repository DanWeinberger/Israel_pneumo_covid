---
title: "pneumo israel"
author: "Dan Weinberger"
date: "1/18/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(reshape2)
library(ggplot2)
library(lubridate)
library(dplyr)
library(INLA)
library(tidyr)
library(htmlTable)
#install.packages("waffle", repos = "https://cinc.rud.is")  
library(waffle)
library(abind)
library(pbapply)
library(rjags)
library(HDInterval)
library(svglite)
library(patchwork)

source('./R/format_carr.R')
source('./R/format_caap.R')
source('./R/format_virus.R')
source('./R/format_ipd_func.R')
source('./R/inla_model3.R')
source('./R/Plot_Obs_exp_counterfact.R')
source('./R/attrib_pct_func.R')
source('./R/attrib_pct_fmt_func.R')
source('./R/attrib_pct_fmt_func_age.R')
source('./R/attrib_pct_waffle_age.R')
source('./R/attrib_pct_waffle_age_mcmc.R')

source('./R/format_post_func1.R')
source('./R/fitted_ci_mcmc.R')
source('./R/attrib_pct_age_mcmc.R')
source('./R/jags_model.R')
source('./R/jags_model_poisson.R')

source('./R/plot_Obs_exp_counterfact_mcmc.R')
source('./R/gen_pred_interval_inla_ridge_ar1.R')
source('./R/attrib_pct_fmt_func_mcmc.R')
source('./R/attrib_pct_fmt_func_age_mcmc.R')

```

-CAAP and non-CAAP LRI 2016-2021 (southern Israel, children <5y)

-IPD 2016-2021 (Nationwide children <5y)

-All viruses (all nasal washes obtained, southern Israel, children <5y)

-CAAP virus coinfections 2016-2021 (Children <5y with CAAP and virus positive, southern Israel)

-Non-CAAP LRI virus coinfections 2016-2021 (Children <5y with non-CAAP LRI and virus positive, southern Israel)

-Carriage plus density 2016-2021 (Children <3y, no respiratory diagnosis, southern Israel)
 

```{r}
carr.formatted <- format_carr()

carr2.c <- carr.formatted$carr2.c

carr2.c <- carr2.c %>%
          group_by(ethnicity, agec) %>%
          mutate(N_swab=POS+NEG,
                  lag1_POS=lag(POS),
                 lag2_pOS=lag(POS,2),
                 lag1_N_swab=lag(N_swab),
                 lag2_N_swab=lag(N_swab,2),
                 prev_movave= (POS+lag1_POS+lag2_pOS)/(N_swab+lag1_N_swab+lag2_N_swab))

p1 <- ggplot(carr2.c, aes(x=date, y=prev_movave, group=ethnicity, col=ethnicity))+
  geom_line() +
  theme_classic()+
  facet_wrap(~agec) +
  ylim(0, 1)

p1
```

Prevalence over time, subsetted by density. The change in prevalence seen in 2020 is due to drop in low-density carriage 
```{r}
carr.formatted$plot.density
```

Viruses

```{r, fig.width=6, fig.height=4}
virus_formatted <- format_virus()

vir2.c <- virus_formatted$vir2.c

virus_formatted$virus.plot
```

## CAAP

```{r, fig.width=6, fig.height=2}
c3 <- format_caap()

p3 <- ggplot(c3, aes(x=date, y=CAAP, group=ethnicity, col=ethnicity)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~agec, scales='free') +
  ggtitle('CAAP by age group and ethnicity')
p3


p4 <- ggplot(c3, aes(x=date, y=nonCAAP, group=ethnicity, col=ethnicity)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~agec, scales='free') +
  ggtitle('non-CAAP by age group and ethnicity')
p4


test <- c3 %>%
  mutate(year=year(date)) %>%
  group_by(agec, year, date) %>% #sum across ethnicity
  summarize(N_caap=sum(CAAP), pop=sum(pop)) %>%
  ungroup() %>%
  group_by(agec, year) %>%
    summarize(N_caap=sum(N_caap), pop=mean(pop)) %>%
  mutate(inc=N_caap/pop*100000)

```

IPD
This script just brings in data for kids <5 year
```{r}
ipd1 <- format_ipd_func()

ipd1$p.ipd_other

ipd1$p.ipd_pneu
```


Combine the virus, carriage and X-rays datasets
```{r}

ipd1$ds <- ipd1$ds %>%
  select(-pop)

all1 <- c3 %>%
  mutate(date=as.Date(date)) %>%
  full_join(carr2.c, by=c('ethnicity', 'agec', 'date') ) %>%
  filter( !is.na(CAAP) & date >= '2016-01-01') %>%
  mutate(prev = if_else(is.na(prev),0, prev)) %>%
  left_join(ipd1$ds, by=c('ethnicity', 'agec', 'date')) %>%
  mutate(date=as.Date(date)) %>%
  tidyr::complete( date = seq.Date(from=as.Date('2016-01-01'), to=as.Date('2022-12-01'), by='month'), ethnicity, agec) %>%
  left_join( vir2.c, by=c('ethnicity', 'date')) %>%
  mutate(ethnicity=as.factor(ethnicity), 
         agec=as.factor(agec),
         caap.pre = if_else(date<as.Date('2020-03-01'), CAAP, NA_real_ ),
         non.caap.pre = if_else(date<as.Date('2020-03-01'), nonCAAP, NA_real_ )) %>%
  arrange(agec, ethnicity, date) %>%
  group_by(agec, ethnicity) %>%
  mutate(t= row_number(), 
         sin12 = sin(2*pi*t/12),
         cos12 = cos(2*pi*t/12),
         sin6 = sin(2*pi*t/6),
         cos6 = cos(2*pi*t/6),
         sin3 = sin(2*pi*t/3),
         cos3 = cos(2*pi*t/3), 
         year=year(date),
         month=month(date),
         epiyr = if_else(month<=6, year-1, year),
         epiyr=if_else(epiyr>2019, 2019, epiyr),
         epiyr=as.factor(epiyr),
         month=as.factor(month)
         ) %>%
  filter(!is.na(agec))
```


## JAGS MODELS

## CAAP, fit to pre-COVID data only

Fit model to pre data only or to any 

```{r, eval=F}
res1.caap.pre <- jags_poisson_func(all1,  outcome.var='caap.pre', plot.var='CAAP')

res1.caap.all <- jags_poisson_func(all1,  outcome.var='CAAP', plot.var='CAAP')
res1.noncaap.pre <- jags_poisson_func(all1,  outcome.var='non.caap.pre', plot.var='nonCAAP')
res1.noncaap.all <- jags_poisson_func(all1,  outcome.var='nonCAAP', plot.var='nonCAAP')
res1.ipd.pneu.all <- jags_poisson_func(all1,  outcome.var='bacteremic.pneumonia', plot.var='bacteremic.pneumonia')
res1.ipd.other.all <- jags_poisson_func(all1,  outcome.var='other.IPD', plot.var='other.IPD')

mod.results <- list( 'res1.caap.pre'=res1.caap.pre,'res1.caap.all'=res1.caap.all,'res1.noncaap.pre'=res1.noncaap.pre,'res1.noncaap.all'=res1.noncaap.all,'res1.ipd.pneu.all'=res1.ipd.pneu.all,'res1.ipd.other.all'=res1.ipd.other.all)
saveRDS(mod.results,'./Results/model_fits_poisson.rds')
```

```{r}
mod.results <- readRDS('./Results/model_fits_poisson.rds')

res1.caap.all <- mod.results$res1.caap.all
res1.noncaap.all <- mod.results$res1.noncaap.all
res1.ipd.pneu.all <- mod.results$res1.ipd.pneu.all
res1.ipd.other.all <- mod.results$res1.ipd.other.all

preds.caap <-  mod.results$res1.caap.all$agec.preds$fitted %>%
  mutate(outcome='CAAP')

preds.non.caap <-  mod.results$res1.noncaap.all$agec.preds$fitted %>%
  mutate(outcome='nonCAAP')

preds.non.ipd.pneu <-  mod.results$res1.ipd.pneu.all$agec.preds$fitted %>%
  mutate(outcome='IPD_pneumonia')

preds.non.ipd.non.pneu <-  mod.results$res1.ipd.other.all$agec.preds$fitted %>%
  mutate(outcome='IPD_Non_pneumonia')

all.preds <- bind_rows(preds.caap,preds.non.caap,preds.non.ipd.pneu,preds.non.ipd.non.pneu) %>%
  mutate(date= as.Date('2016-01-01') + months(time-1) )

write.csv(all.preds,'Results/pred2022.csv')

ggplot(all.preds, aes(x=date, y=pred)) +
  geom_line()+
  theme_minimal()+
  facet_grid(outcome~ agec, scales='free_y')

```






