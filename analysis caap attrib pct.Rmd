---
title: "pneumo israel"
author: "Dan Weinberger"
date: "2/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(reshape2)
library(ggplot2)
library(lubridate)
library(dplyr)
library(INLA)
library(tidyr)
library(pbapply)

source('./R/format_carr.R')
source('./R/format_caap.R')
source('./R/format_virus.R')
source('./R/format_ipd_func.R')
source('./R/inla_model3.R')
source('./R/Plot_Obs_exp_counterfact.R')
source('./R/attrib_pct_func.R')

source('./R/gen_pred_interval_inla_ridge_ar1.R')

```

-CAAP and non-CAAP LRI 2016-2021 (southern Israel, children <5y)

-IPD 2016-2021 (Nationwide children <5y)

-All viruses (all nasal washes obtained, southern Israel, children <5y)

-CAAP virus coinfections 2016-2021 (Children <5y with CAAP and virus positive, southern Israel)

-Non-CAAP LRI virus coinfections 2016-2021 (Children <5y with non-CAAP LRI and virus positive, southern Israel)

-Carriage plus density 2016-2021 (Children <3y, no respiratory diagnosis, southern Israel)
 

```{r}
carr.formatted <- format_carr()

carr2.c <- carr.formatted$carr2.c

carr2.c <- carr2.c %>%
          group_by(ethnicity, agec) %>%
          mutate(N_swab=POS+NEG,
                  lag1_POS=lag(POS),
                 lag2_pOS=lag(POS,2),
                 lag1_N_swab=lag(N_swab),
                 lag2_N_swab=lag(N_swab,2),
                 prev_movave= (POS+lag1_POS+lag2_pOS)/(N_swab+lag1_N_swab+lag2_N_swab))

p1 <- ggplot(carr2.c, aes(x=date, y=prev_movave, group=ethnicity, col=ethnicity))+
  geom_line() +
  theme_classic()+
  facet_wrap(~agec) +
  ylim(0, 1)

p1
```

Prevalence over time, subsetted by density. The change in prevalence seen in 2020 is due to drop in low-density carriage 
```{r}
carr.formatted$plot.density
```

Viruses

```{r, fig.width=6, fig.height=4}
virus_formatted <- format_virus()

vir2.c <- virus_formatted$vir2.c

virus_formatted$virus.plot
```

## CAAP

```{r, fig.width=6, fig.height=2}
c3 <- format_caap()

p3 <- ggplot(c3, aes(x=date, y=CAAP, group=ethnicity, col=ethnicity)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~agec, scales='free') +
  ggtitle('CAAP by age group and ethnicity')
p3


p4 <- ggplot(c3, aes(x=date, y=nonCAAP, group=ethnicity, col=ethnicity)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~agec, scales='free') +
  ggtitle('non-CAAP by age group and ethnicity')
p4

```

IPD
This script just brings in data for kids <1 year
```{r}
ipd1 <- format_ipd_func()

ipd1$p.ipd_other

ipd1$p.ipd_pneu
```


Combine the virus, carriage and X-rays datasets
```{r}
all1 <- merge(c3, carr2.c, by=c('ethnicity', 'agec', 'date'), all=T)

all1 <- all1[!is.na(all1$CAAP) & all1$date>='2016-01-01',]

all1$prev[is.na(all1$prev)] <-0

all1 <- merge(all1, vir2.c, by=c('ethnicity', 'date'), all=T)


all1$ethnicity <- as.factor(all1$ethnicity)

all1$agec <- as.factor(all1$agec)

all1$caap.pre <- all1$CAAP

all1$caap.pre[all1$date>=as.Date('2020-03-01')] <- NA

all1$non.caap.pre <- all1$nonCAAP
all1$non.caap.pre[all1$date>=as.Date('2020-03-01')] <- NA

all1$t <- interval(min(all1$date), all1$date) %/% months(1) 
all1$sin12 <- sin(2*pi*all1$t/12)
all1$cos12 <- cos(2*pi*all1$t/12)

all1$sin6 <- sin(2*pi*all1$t/6)
all1$cos6 <- cos(2*pi*all1$t/6)

all1$sin3 <- sin(2*pi*all1$t/3)
all1$cos3 <- cos(2*pi*all1$t/3)

all1$year <- year(all1$date)
all1$month <- month(all1$date)

all1$epiyr <- all1$year
all1$epiyr[all1$month<=6] <- all1$year[all1$month<=6]  - 1
all1$epiyr[all1$epiyr >2019] <- 2019
all1$epiyr <- as.factor(all1$epiyr)

all1$month <- as.factor(all1$month)

all1 <- all1[!is.na(all1$agec),]

```



## INLA MODELS

## CAAP, fit to pre-COVID data only

```{r}
res1.caap.pre <- inla_model3(all1,  outcome.var='caap.pre', plot.var='CAAP')
```

```{r}

res1.caap.pre$obs_exp_plot

```

```{r, fig.width=4, fig.height=4}
res1.caap.pre$predict_plot
```
percent attributable to any virus
```{r}
res1.caap.pre$attrib_pct$attrib_pct_any

res1.caap.pre$attrib_pct$attrib_pct_any_age

```

RSV attrib pct
```{r}
res1.caap.pre$attrib_pct$attrib_pct_RSV

res1.caap.pre$attrib_pct$attrib_pct_RSV_age
```

HMPV attrib pct
```{r}
res1.caap.pre$attrib_pct$attrib_pct_HMPV

res1.caap.pre$attrib_pct$attrib_pct_HMPV_age
```

## CAAP, fit to ALL data

```{r}

res1.caap.all <- inla_model3(all1,  outcome.var='CAAP', plot.var='CAAP')
```

```{r}
res1.caap.all$obs_exp_plot
```

```{r, fig.width=4, fig.height=4}
res1.caap.all$predict_plot
```

percent attributable to any virus
```{r}
res1.caap.all$attrib_pct$attrib_pct_any

res1.caap.all$attrib_pct$attrib_pct_any_age

```

RSV attrib pct
```{r}
res1.caap.all$attrib_pct$attrib_pct_RSV

res1.caap.all$attrib_pct$attrib_pct_RSV_age
```

HMPV attrib pct
```{r}
res1.caap.all$attrib_pct$attrib_pct_HMPV

res1.caap.all$attrib_pct$attrib_pct_HMPV_age
```

Flu attrib pct
```{r}
res1.caap.all$attrib_pct$attrib_pct_HMPV

res1.caap.all$attrib_pct$attrib_pct_HMPV_age
```



